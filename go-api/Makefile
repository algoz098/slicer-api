# Makefile para Slicer API

# VariÃ¡veis
BINARY_NAME=slicer-api
CMD_PATH=./cmd/server
BUILD_DIR=./bin

# Comandos principais
.PHONY: run build test clean dev docs help

# Executar em modo desenvolvimento
run:
	@echo "ğŸš€ Iniciando servidor em modo desenvolvimento..."
	go run $(CMD_PATH)

# Gerar documentaÃ§Ã£o Swagger
docs:
	@echo "ğŸ“š Gerando documentaÃ§Ã£o Swagger..."
	@if command -v swag > /dev/null; then \
		swag init -g $(CMD_PATH)/main.go -o ./docs; \
	else \
		echo "âŒ swag nÃ£o encontrado. Instale com: go install github.com/swaggo/swag/cmd/swag@latest"; \
	fi

# Compilar aplicaÃ§Ã£o
build: docs
	@echo "ğŸ”¨ Compilando aplicaÃ§Ã£o..."
	go build -o $(BUILD_DIR)/$(BINARY_NAME) $(CMD_PATH)

# Executar testes
test:
	@echo "ğŸ§ª Executando testes..."
	go test -v ./...

# Executar testes com coverage
test-coverage:
	@echo "ğŸ“Š Executando testes com coverage..."
	go test -v -cover ./...

# Limpar arquivos compilados
clean:
	@echo "ğŸ§¹ Limpando arquivos compilados..."
	rm -rf $(BUILD_DIR)/*

# Modo desenvolvimento com hot reload (requer air)
dev:
	@echo "ğŸ”¥ Iniciando com hot reload..."
	@if command -v air > /dev/null; then \
		air; \
	else \
		echo "âŒ Air nÃ£o encontrado. Instale com: go install github.com/cosmtrek/air@latest"; \
		echo "ğŸ“ Usando go run normal..."; \
		go run $(CMD_PATH); \
	fi

# Verificar dependÃªncias
deps:
	@echo "ğŸ“¦ Verificando dependÃªncias..."
	go mod tidy
	go mod verify

# Verificar cÃ³digo
lint:
	@echo "ğŸ” Verificando cÃ³digo..."
	@if command -v golangci-lint > /dev/null; then \
		golangci-lint run; \
	else \
		echo "âŒ golangci-lint nÃ£o encontrado. Usando go vet..."; \
		go vet ./...; \
	fi

# Formatar cÃ³digo
fmt:
	@echo "âœ¨ Formatando cÃ³digo..."
	go fmt ./...

# Docker commands
docker-build:
	@echo "ğŸ³ Construindo imagem Docker..."
	docker build -t $(BINARY_NAME) .

docker-run:
	@echo "ğŸ³ Executando container Docker..."
	docker run -p 8080:8080 $(BINARY_NAME)

# Instalar ferramentas de desenvolvimento
install-tools:
	@echo "ğŸ› ï¸ Instalando ferramentas de desenvolvimento..."
	go install github.com/cosmtrek/air@latest
	go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

# Mostrar ajuda
help:
	@echo "ğŸ“– Comandos disponÃ­veis:"
	@echo "  make run           - Executar servidor"
	@echo "  make build         - Compilar aplicaÃ§Ã£o"
	@echo "  make test          - Executar testes"
	@echo "  make test-coverage - Testes com coverage"
	@echo "  make dev           - Modo desenvolvimento (hot reload)"
	@echo "  make clean         - Limpar arquivos compilados"
	@echo "  make deps          - Verificar dependÃªncias"
	@echo "  make lint          - Verificar cÃ³digo"
	@echo "  make fmt           - Formatar cÃ³digo"
	@echo "  make docker-build  - Construir imagem Docker"
	@echo "  make docker-run    - Executar container"
	@echo "  make install-tools - Instalar ferramentas dev"
	@echo "  make help          - Mostrar esta ajuda"

# Comando padrÃ£o
all: deps fmt lint test build
