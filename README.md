# OrcaSlicer CLI

Uma interface de linha de comando para o OrcaSlicer, permitindo fatiar arquivos STL e gerar G-code sem interface grÃ¡fica.

## ğŸ“ Estrutura do Projeto

```
.
â”œâ”€â”€ OrcaSlicer/          # CÃ³digo fonte original do OrcaSlicer (nÃ£o modificar)
â”œâ”€â”€ OrcaSlicerCli/       # Interface CLI (trabalho em progresso)
â”œâ”€â”€ example_files/       # Arquivos de exemplo para teste
â”‚   â””â”€â”€ 3DBenchy.stl    # Modelo de teste
â”œâ”€â”€ output_files/        # Arquivos G-code gerados
â”œâ”€â”€ slice_3dbenchy.sh    # Script automatizado de fatiamento
â””â”€â”€ README.md           # Este arquivo
```

## ğŸš€ Uso RÃ¡pido

### Script Automatizado

Para fatiar o 3DBenchy.stl rapidamente:

```bash
./slice_3dbenchy.sh
```

Este script:
- âœ… Verifica se todos os arquivos necessÃ¡rios existem
- âœ… Executa o fatiamento do 3DBenchy.stl
- âœ… Gera G-code completo na pasta `output_files/`
- âœ… Lida automaticamente com o segfault na finalizaÃ§Ã£o
- âœ… Fornece feedback colorido do progresso

### Uso Manual

```bash
cd OrcaSlicerCli/build
./bin/orcaslicer-cli slice --input ../../example_files/3DBenchy.stl --output ../../output_files/3DBenchy.gcode
```

- Exportar 3MF de produÃ§Ã£o (G-code embutido) a partir de um projeto .3mf (plate 1):
```bash
./bin/orcaslicer-cli slice \
  --input ../../example_files/3DBenchy.3mf \
  --output ../../output_files/3DBenchy_plate_1.gcode.3mf \
  --plate 1
```

- Plate 2:
```bash
./bin/orcaslicer-cli slice \
  --input ../../example_files/3DBenchy.3mf \
  --output ../../output_files/3DBenchy_plate_2.gcode.3mf \
  --plate 2
```

Dica: a extensÃ£o do arquivo de saÃ­da define o formato gerado. Se terminar com `.3mf`, o CLI empacota o G-code em um 3MF de produÃ§Ã£o (paridade com o Orca GUI: SaveStrategy `Silence|SplitModel|WithGcode|SkipModel|Zip64`). Caso contrÃ¡rio, gera `.gcode` puro.

## ğŸ§© Paridade com o GUI para 3MF de produÃ§Ã£o (G-code embutido)

- O CLI reproduz o mesmo fluxo do GUI ao exportar 3MF de produÃ§Ã£o (Export plate sliced file):
  - PresetBundle â†’ full_config_secure()
  - Print.apply() â†’ Print.process() â†’ Print.export_gcode()
  - Empacotamento via store_bbs_3mf() com SaveStrategy: Silence | SplitModel | WithGcode | SkipModel | Zip64
- A extensÃ£o do arquivo de saÃ­da controla o modo:
  - .gcode â†’ G-code puro
  - .3mf â†’ 3MF de produÃ§Ã£o com G-code embutido (gcode.3mf)
- SeleÃ§Ã£o de plate em projetos .3mf: use --plate N (1â€‘based). O Ã­ndice Ã© propagado para Print e Model de forma idÃªntica ao GUI, garantindo parÃ¢metros por-placa corretos (ex.: wipe_tower_x/y).

### CritÃ©rios de comparaÃ§Ã£o/validaÃ§Ã£o (paridade)
Para comparar o G-code embutido com arquivos gerados pelo GUI, usamos as regras abaixo:
- Ignorar no HEADER: a linha â€œgenerated by â€¦â€ (data/hora) e â€œmodel label idâ€.
- Exigir paridade real de tempos: â€œmodel printing timeâ€ e â€œtotal estimated timeâ€.
- Exigir paridade integral do CONFIG_BLOCK (inclui wipe_tower_x/y por placa).
- No corpo do G-code, ignorar linhas M73 (progresso), pois variam com o ambiente.

### Teste automatizado de paridade
HÃ¡ um teste pronto que gera .gcode.3mf para plates 1 e 2 a partir de example_files/3DBenchy.3mf e compara com os arquivos de referÃªncia em comparable_files/:

```bash
cd OrcaSlicerCli
bash test_3mf_production.sh
```

SaÃ­da esperada:
- â€œG-code embutido idÃªntico ao de referÃªncia (com normalizaÃ§Ãµes permitidas)â€ para cada plate.

ObservaÃ§Ã£o: Os arquivos de referÃªncia foram gerados com o mesmo build do OrcaSlicer (GUI). Se vocÃª atualizar o OrcaSlicer, gere novos arquivos de referÃªncia para manter a paridade.


## ğŸ”§ CompilaÃ§Ã£o

### PrÃ©-requisitos

- macOS com Xcode Command Line Tools
- CMake 3.13+ (localizado em `/Applications/CMake.app/Contents/bin/cmake`)
- Arquitetura ARM64 (Apple Silicon)

### Compilar o Projeto

```bash
cd OrcaSlicerCli/build
rm -rf *  # Limpar build anterior
/Applications/CMake.app/Contents/bin/cmake ..
make -j4
```

## ğŸ“Š Status do Projeto

### âœ… Funcionalidades Implementadas

- **Carregamento de STL**: LÃª arquivos STL usando `Slic3r::TriangleMesh::ReadSTLFile()`
- **ConfiguraÃ§Ã£o Completa**: Usa `DynamicPrintConfig::full_print_config()` com 503 opÃ§Ãµes
- **Pipeline de Slicing**: Implementa o pipeline completo do OrcaSlicer
  - AplicaÃ§Ã£o de modelo e configuraÃ§Ã£o
  - Processamento de slicing (paredes, superfÃ­cies, preenchimento)
  - DetecÃ§Ã£o de suporte
  - VerificaÃ§Ã£o de conflitos
- **GeraÃ§Ã£o de G-code**: Exporta G-code completo e vÃ¡lido
- **Interface CLI**: Comandos `slice` e `info` funcionais

### ğŸ”§ Problemas Conhecidos

- **Segfault na FinalizaÃ§Ã£o**: O processo termina com segmentation fault apÃ³s gerar o G-code, mas o arquivo Ã© criado corretamente
- **Arquivo TemporÃ¡rio**: O G-code Ã© salvo como `.tmp` e precisa ser renomeado (o script faz isso automaticamente)

### âœ… Problemas Resolvidos

- **Template filename_format**: Corrigido erro de parsing do template `{filament_type[initial_tool]}` configurando um template simples `{input_filename_base}.gcode`
- **Caminhos Absolutos**: Agora funciona com caminhos absolutos e relativos
- **DiretÃ³rio de SaÃ­da**: Suporte para especificar apenas o diretÃ³rio (nome do arquivo gerado automaticamente)

### ğŸ“ˆ Resultados

- **Arquivo de Entrada**: `3DBenchy.stl` (225.154 triÃ¢ngulos, 15.550,4 mmÂ³)
- **Arquivo de SaÃ­da**: `3DBenchy.gcode` (3.4MB, G-code completo)
- **Tempo de Processamento**: ~2-3 segundos
- **MemÃ³ria Utilizada**: ~200MB pico

## ğŸ› ï¸ Detalhes TÃ©cnicos

### DependÃªncias Resolvidas

O projeto integra com sucesso as seguintes bibliotecas do OrcaSlicer:

- **libslic3r**: Biblioteca principal de slicing (50MB)
- **libslic3r_cgal**: ExtensÃµes CGAL (7MB)
- **Boost**: Headers e bibliotecas
- **Eigen**: Ãlgebra linear
- **OpenCASCADE**: 38+ bibliotecas CAD
- **TBB**: Threading Building Blocks
- **Outras**: PNG, JPEG, FreeType, Expat, Crypto, etc.

### ConfiguraÃ§Ã£o

- **Layer Height**: 0.2mm
- **Perimeters**: 3
- **Infill**: 20%
- **Nozzle**: 0.4mm
- **Filament**: 1.75mm PLA
- **Temperatures**: 210Â°C extruder, 60Â°C bed

### Arquitetura

```
CliCore.cpp
â”œâ”€â”€ initializeSlic3r()     # Inicializa configuraÃ§Ã£o completa
â”œâ”€â”€ loadModelFromFile()    # Carrega STL usando TriangleMesh
â”œâ”€â”€ performSlicing()       # Pipeline: apply() â†’ process() â†’ export_gcode()
â””â”€â”€ getModelInformation()  # InformaÃ§Ãµes do modelo
```


### Multi-plates 3MF (normalizaÃ§Ã£o do plate)

- Projetos 3MF (especialmente da Bambu) guardam mÃºltiplos plates em um grid lÃ³gico, com um â€œgapâ€ entre pratos.
- A GUI do OrcaSlicer normaliza o plate selecionado removendo o deslocamento global do grid e recentrando no bed.
- O CLI agora replica exatamente esse comportamento quando usado com `--plate` em arquivos `.3mf`:
  - Calcula o stride do plate a partir da Ã¡rea imprimÃ­vel (bed) e do gap lÃ³gico (`LOGICAL_PART_PLATE_GAP = 1/5`).
  - Estima a coluna/linha do plate a partir dos offsets absolutos das instÃ¢ncias e recenter para a origem do bed.
  - Aplica apenas para `.3mf` quando `--plate >= 2` (plates alÃ©m do primeiro). Para STL/OBJ nÃ£o se aplica.
- Resultado: o G-code do plate selecionado abre na GUI centralizado no bed, igual ao que a GUI mostraria ao fatiar aquele plate.
- Teste 2b (3MF plate 2) valida essa normalizaÃ§Ã£o e passou com G-code idÃªntico ao arquivo de referÃªncia.

## ğŸ“ Logs de Exemplo

```
2025-09-15 15:32:53.205 [000INFO] Starting slice operation...
DEBUG: Loaded full print config with 503 options
DEBUG: Model has 1 objects
DEBUG: Apply completed successfully
DEBUG: Print processing completed
[info] Slicing process finished. Resident memory: 199MB; Peak memory usage: 201MB
âœ… Fatiamento concluÃ­do com sucesso!
ğŸ“ Arquivo gerado: output_files/3DBenchy.gcode (3.4M)
```

## ğŸ¯ PrÃ³ximos Passos

1. **Corrigir Segfault**: Investigar e corrigir o segmentation fault na finalizaÃ§Ã£o
2. **ConfiguraÃ§Ãµes CustomizÃ¡veis**: Permitir configuraÃ§Ãµes personalizadas via CLI
3. **MÃºltiplos Formatos**: Suporte para outros formatos alÃ©m de STL
4. **OtimizaÃ§Ãµes**: Melhorar performance e uso de memÃ³ria

## ğŸ“„ LicenÃ§a

Este projeto utiliza o cÃ³digo fonte do OrcaSlicer. Consulte as licenÃ§as originais do OrcaSlicer para mais informaÃ§Ãµes.

---

**Desenvolvido com OrcaSlicer libslic3r** ğŸš€
